<div>
  <h2>POC Multi-Uploader usando Chunk para la manipulacion de Archivos en Multipart As√≠ncrono (Angular 20)</h2>
  <p>Configuraci√≥n autom√°tica: PDFs ligeros, videos pesados, cualquier tama√±o ‚Ä¢ Multi-selecci√≥n simult√°nea</p>

  <!-- Zona de Drag & Drop -->
  <div
    class="drop-zone"
    [class.drag-over]="isDragOver()"
    (dragover)="onDragOver($event)"
    (dragleave)="onDragLeave($event)"
    (drop)="onDrop($event)"
    (click)="fileInput.click()">

    @if (files().length === 0) {
      <div>
        <div>
          @if (isDragOver()) {
            <span>‚Üì</span>
          } @else {
            <span>+</span>
          }
        </div>
        <div>
          @if (isDragOver()) {
            <span>¬°Suelta los archivos aqu√≠!</span>
          } @else {
            <span>Arrastra m√∫ltiples archivos aqu√≠</span>
          }
        </div>
        <div>
          o <span>haz clic para seleccionar m√∫ltiples archivos</span>
        </div>
        <div>
          Soporta cualquier tipo de archivo y tama√±o<br>
          PDF, Videos, Im√°genes, Documentos, etc.
        </div>
      </div>
    } @else {
      <div>
        <div>{{ totalFiles() }} archivo(s) seleccionado(s)</div>
        <div>Progreso global: {{ globalProgress() }}%</div>
        <button class="btn btn-secondary" (click)="clearFile($event)">Limpiar todo</button>
      </div>
    }
  </div>

  <!-- Input file oculto -->
  <input
    #fileInput
    type="file"
    multiple
    (change)="onFile($event)"
    style="display: none;" />

  <!-- Lista de archivos -->
  @if (files().length > 0) {
    <div style="margin-top: 20px;">
      <h3>Archivos ({{ completedFiles() }}/{{ totalFiles() }} completados)</h3>

      @for (file of files(); track file.fileName; let i = $index) {
        <div
          class="file-item"
          [class.uploading]="file.uploading"
          [class.assembling]="file.assembling"
          [class.done]="file.done"
          [class.error]="file.error">
          <!-- Header del archivo -->
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <div>
              <span>{{ getFileIcon(file.fileName) }}</span>
              <strong>{{ file.fileName }}</strong>
              <span>({{ humanSize(file.totalBytes) }})</span>
            </div>
            @if (!file.uploading && !file.assembling && !file.paused) {
              <button 
                class="btn btn-danger" 
                (click)="removeFile(i, $event)">
                Eliminar
              </button>
            }
          </div>

          <!-- Barra de progreso mejorada -->
          @if (file.uploading || file.assembling || (file.percent > 0 && (file.done || file.error))) {
            <div style="background: #f0f0f0; height: 12px; border-radius: 6px; margin: 10px 0; overflow: hidden; box-shadow: inset 0 1px 3px rgba(0,0,0,0.2);">
              <div
                style="height: 100%; border-radius: 6px; transition: width 0.2s ease-out;"
                [style.width.%]="file.percent"
                [style.background]="file.uploading ? 'linear-gradient(90deg, #4CAF50, #81C784)' :
                                   file.assembling ? 'linear-gradient(90deg, #FF9800, #FFB74D)' :
                                   file.done ? '#4CAF50' :
                                   file.error ? '#f44336' : '#2196F3'">
                @if (file.uploading) {
                  <!-- Animaci√≥n de progreso activo para upload -->
                  <div style="
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
                    animation: shimmer 1.5s infinite;
                  "></div>
                }
                @if (file.assembling) {
                  <!-- Animaci√≥n diferente para ensamblado -->
                  <div style="
                    height: 100%;
                    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
                    animation: shimmer 2s infinite;
                  "></div>
                }
              </div>
            </div>

            <!-- Informaci√≥n detallada del progreso -->
            <div style="font-size: 12px; color: #666; display: flex; justify-content: space-between;">
              <span>
                <strong>{{ file.percent }}%</strong> ‚Äî {{ humanSize(file.sentBytes) }} / {{ humanSize(file.totalBytes) }}
              </span>
              <span>
                @if (file.speedBps && file.uploading) {
                  <span style="color: #2196F3;">{{ humanSize(file.speedBps) }}/s</span>
                }
                @if (file.etaSeconds && file.uploading && file.etaSeconds > 0) {
                  <span style="color: #FF9800; margin-left: 8px;">ETA: {{ file.etaSeconds | number:'1.0-0' }}s</span>
                }
              </span>
            </div>
          }          
          <!-- Estados -->
          <div style="margin-top: 10px;">
            @if (file.uploading) {
              <span style="color: blue;">üì§ Subiendo chunks...</span>
            } @else if (file.assembling) {
              <span style="color: orange;">‚öôÔ∏è Ensamblando archivo final... (No se puede cancelar)</span>
            } @else if (file.done) {
              <span style="color: green;">‚úÖ Completado</span>
            } @else if (file.error) {
              <span style="color: red;">Error: {{ file.error }}</span>
            } @else {
              <span style="color: gray;">Pendiente</span>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- Controles globales -->
  @if (files().length > 0) {
    <div style="margin-top: 20px;">
      @if (assemblingFiles() > 0) {
        <div class="alert alert-info" style="margin-bottom: 15px;">
          <strong>‚öôÔ∏è Ensamblando archivos...</strong><br>
          {{ assemblingFiles() }} archivo(s) en fase final de procesamiento. Los controles est√°n deshabilitados durante esta fase.
        </div>
      }
      <button class="btn btn-primary" (click)="start()" [disabled]="!canStart()">Subir Todos</button>
      <button class="btn btn-secondary" (click)="pause()" [disabled]="!canPause()">Pausar Todo</button>
      <button class="btn btn-secondary" (click)="resume()" [disabled]="!canResume()">Reanudar Todo</button>
      <button class="btn btn-danger" (click)="cancel()" [disabled]="!canCancel()">Cancelar Todo</button>
    </div>
  }

  <!-- Estad√≠sticas globales -->
  @if (files().length > 0) {
    <div style="margin-top: 20px; padding: 10px; background: #f9f9f9; border-radius: 5px;">
      <strong>Estad√≠sticas:</strong><br>
      Total: {{ totalFiles() }} archivos<br>
      Completados: {{ completedFiles() }}<br>
      Subiendo: {{ uploadingFiles() }}<br>
      @if (assemblingFiles() > 0) {
        Ensamblando: {{ assemblingFiles() }}<br>
      }
      Progreso global: {{ globalProgress() }}%
    </div>
  }
</div>
